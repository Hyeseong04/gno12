# 파이썬 트레이딩 저자의 코드 모음
https://github.com/pystockhub/book/blob/master/ch08/03.py
# 교재 (온라인)
https://wikidocs.net/3682


### 1부-파이썬프로그래밍 - 2부 증권사 API 기초

마이크로소프트 기술인 COM의 뜻? 여러 컴포넌트 객체를 파이썬에서 사용하도록 도와주는 것. 객체지향과 비슷.
win32com.client라는 모듈 내에 dispatch라는 함수로 사용가능 (익스플로어 , 워드, 엑셀 띄우기 가능)

[엑셀 열기] 
importwin32com.clientaswin32
excel=win32.gencache.EnsureDispatch('Excel.Application')

excel.Visible=True
wb=excel.Workbooks.Add()
ws=wb.Workbooks("Sheet1")

[대신증권 API 이용] 

import win32com.client

[연결 상태 확인 : 1, 0]
instCpCybos = win32com.client.Dispatch("CpUtil.CpCybos")
print(instCpCybos.IsConnect)

[종목코드 수]
instCpCybos = win32com.client.Dispatch("CpUtil.CpStockCode")
print(instCpCybos.GetCount())

[종목데이터(type, index)] 
import win32com.client

instCpCybos = win32com.client.Dispatch("CpUtil.CpStockCode")
for i in range(0, 10):
    print(instCpCybos.GetData(1, i))

>>> 동화약품
    KR모터스
    경방
    메리츠화재
    삼양홀딩스
    삼양홀딩스우
    하이트진로
    하이트진로2우B
    유한양행
    유한양행우

instCpStockCode = win32com.client.Dispatch("CpUtil.CpStockCode")
stockNum = instCpStockCode.GetCount()

for i in range(stockNum):
    if instCpStockCode.GetData(1, i) == 'NAVER':
        print(instCpStockCode.GetData(0, i))
        print(instCpStockCode.GetData(1, i))
        print(i)
        
>>> A035420
    NAVER
    868

instCpCodeMgr = win32com.client.Dispatch("CpUtil.CpCodeMgr")
codeList = instCpCodeMgr.GetStockListByMarket(1)

Kospi = {}
for code in codeList:
    name = instCpCodeMgr.CodeToName(code)
    Kospi[code] = name

f = open(r'C:\Users\nhss0\OneDrive\바탕 화면\Kospi.csv', 'w')
for key, value in Kospi.items():
    f.write("%s,%s\n" % (key, value))
f.close()

>>> CSV파일로 바탕화면에 저장

[과거 데이터 구하기] CYBOS plus의 CpSysDib모듈에 StockChart 클래스 사용
거래량 분석을 통해 유망한 투자 종목을 뽑는 프로그램을 개발한다면 각 종목에 대한 일정 기간의 거래량 데이터가 필요하기 때문에

{10일치 종가데이터 구하는 코드}
import win32com.client

instStockChart = win32com.client.Dispatch("CpSysDib.StockChart")

instStockChart.SetInputValue(0, "A003540") # 0은 종목 코드를 의미, 조회하려는 종목의 코드값
instStockChart.SetInputValue(1, ord('2')) # 아스키코드로 변환(기간요청 1 개수 요청 2)
instStockChart.SetInputValue(4, 10) # 4는 요청 개수라는 타입 의미, 최근 거래일로부터 10일치의 데이터
instStockChart.SetInputValue(5, 5) # 도움말 참조 5는 종가를 의미
instStockChart.SetInputValue(6, ord('D')) # 일 단위의 데이터
instStockChart.SetInputValue(9, ord('1')) # 수정주가의 반영여부

instStockChart.BlockRequest() # 증권사 서버에 요청하고

numData = instStockChart.GetHeaderValue(3) # 가져오는데 3은 받아온 데이터의 개수 우리는 10일치 데이터를 구했으니 10임.

for i in range(numData):
    print(instStockChart.GetDataValue(0, i)) 0은 종목코드 반환받을 타입 인덱스, 요청한 종목의 개수ㅗ

>>> 10일간의 대신증권 종가 출력

{일별 일자, 시가, 고가, 저가, 종가, 거래량을 구하는 코드}

import win32com.client

#### create object
instStockChart = win32com.client.Dispatch("CpSysDib.StockChart")

#### SetinputValue
instStockChart.SetInputValue(0, "A003540") # 0은 종목 코드를 의미, 조회하려는 종목의 코드값
instStockChart.SetInputValue(1, ord('2')) # 아스키코드로 변환(기간요청 1 개수 요청 2)
instStockChart.SetInputValue(4, 10) # 4는 요청 개수라는 타입 의미, 최근 거래일로부터 10일치의 데이터
instStockChart.SetInputValue(5, (0, 2, 3, 4, 5, 8)) # 도움말 참조 5는 종가를 의미
instStockChart.SetInputValue(6, ord('D')) # 일 단위의 데이터
instStockChart.SetInputValue(9, ord('1')) # 수정주가의 반영여부

#### BlockRequest
instStockChart.BlockRequest()

#### GetHeaderValue
numData = instStockChart.GetHeaderValue(3) # = 10
numField = instStockChart.GetHeaderValue(1) # = 6

#### GetDataValue
for i in range(numData):
    for j in range(numField):
        print(instStockChart.GetDataValue(j, i), end=" ")
    print("")

{다른 지표 구하는 코드}
import win32com.client

#### 객체 생성
instMarketEye = win32com.client.Dispatch("CpSysDib.MarketEye")

#### SetInputValue
instMarketEye.SetInputValue(0, (4, 67, 70, 111))
instMarketEye.SetInputValue(1, 'A003540')

#### BlockRequest
instMarketEye.BlockRequest()

#### GetData
print("현재가: ", instMarketEye.GetDataValue(0, 0))
print("PER: ", instMarketEye.GetDataValue(1, 0))
print("EPS: ", instMarketEye.GetDataValue(2, 0))
print("최근분기년월: ", instMarketEye.GetDataValue(3, 0))

찾아보니 대신증권 API에서 현금흐름, 영업흐름, 재무흐름 등은 없는듯..

{API를 이용한 알고리즘 개발}
ㅇ
